{% extends "base.html" %}

{% block title %}Modbus Server{% endblock %}
{% block page_title %}Mock Modbus Server (RTU){% endblock %}

{% block header_actions %}
<button class="btn" id="btn-toggle" onclick="toggleModbus()">
    <span id="toggle-text">‚ñ∂ Start</span>
</button>
{% endblock %}

{% block content %}
<div class="settings-page">
    <div class="settings-grid">
        <!-- –°–µ–∫—Ü–∏—è –°–µ—Ä–≤–µ—Ä -->
        <div class="card">
            <div class="card-header">
                <h3>üîå –°–µ—Ä–≤–µ—Ä</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label>–ü–æ—Ä—Ç</label>
                    <input type="number" id="cfg-port" value="5020" min="1024" max="65535">
                </div>
                <div class="form-group">
                    <label>Unit ID</label>
                    <input type="number" id="cfg-unit-id" value="16" min="1" max="247">
                </div>
            </div>
        </div>
        
        <!-- –°–µ–∫—Ü–∏—è –î–∞—Ç—á–∏–∫–∏ -->
        <div class="card">
            <div class="card-header">
                <h3>üì° –î–∞—Ç—á–∏–∫–∏</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∞—Ç—á–∏–∫–æ–≤</label>
                    <input type="range" id="cfg-sensors" min="1" max="127" value="10" 
                           oninput="document.getElementById('sensors-val').textContent = this.value">
                    <span id="sensors-val">10</span>
                </div>
                <div class="form-group">
                    <label>–ë–∞–∑–æ–≤—ã–π –∞–¥—Ä–µ—Å –∑–Ω–∞—á–µ–Ω–∏–π</label>
                    <input type="number" id="cfg-value-base" value="30000" min="0" max="65535">
                </div>
                <div class="form-group">
                    <label>–ë–∞–∑–æ–≤—ã–π –∞–¥—Ä–µ—Å —Å—Ç–∞—Ç—É—Å–æ–≤</label>
                    <input type="number" id="cfg-status-base" value="40000" min="0" max="65535">
                </div>
            </div>
        </div>
        
        <!-- –°–µ–∫—Ü–∏—è –ó–Ω–∞—á–µ–Ω–∏—è -->
        <div class="card">
            <div class="card-header">
                <h3>üå°Ô∏è –ó–Ω–∞—á–µ–Ω–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã</h3>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Base</label>
                        <input type="number" id="cfg-temp-base" value="22" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Variation</label>
                        <input type="number" id="cfg-temp-var" value="2" step="0.1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Min</label>
                        <input type="number" id="cfg-temp-min" value="-40" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Max</label>
                        <input type="number" id="cfg-temp-max" value="85" step="0.1">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –°–µ–∫—Ü–∏—è –ó–Ω–∞—á–µ–Ω–∏—è –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ -->
        <div class="card">
            <div class="card-header">
                <h3>üíß –ó–Ω–∞—á–µ–Ω–∏—è –≤–ª–∞–∂–Ω–æ—Å—Ç–∏</h3>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Base</label>
                        <input type="number" id="cfg-hum-base" value="45" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Variation</label>
                        <input type="number" id="cfg-hum-var" value="5" step="0.1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Min</label>
                        <input type="number" id="cfg-hum-min" value="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Max</label>
                        <input type="number" id="cfg-hum-max" value="100" step="0.1">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –°–µ–∫—Ü–∏—è –û—à–∏–±–∫–∏ -->
        <div class="card">
            <div class="card-header">
                <h3>‚ö†Ô∏è –°–∏–º—É–ª—è—Ü–∏—è –æ—à–∏–±–æ–∫</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label>Error Rate</label>
                    <input type="range" id="cfg-error-rate" min="0" max="100" value="0"
                           oninput="document.getElementById('error-val').textContent = this.value + '%'">
                    <span id="error-val">0%</span>
                </div>
                <div class="form-group">
                    <label>Timeout Rate</label>
                    <input type="range" id="cfg-timeout-rate" min="0" max="100" value="0"
                           oninput="document.getElementById('timeout-val').textContent = this.value + '%'">
                    <span id="timeout-val">0%</span>
                </div>
                <div class="form-group">
                    <label>Offline –¥–∞—Ç—á–∏–∫–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                    <input type="text" id="cfg-offline" placeholder="1, 3, 5">
                </div>
            </div>
        </div>
        
        <!-- –°–µ–∫—Ü–∏—è –°—Ü–µ–Ω–∞—Ä–∏–π -->
        <div class="card">
            <div class="card-header">
                <h3>üé≠ –°—Ü–µ–Ω–∞—Ä–∏–π</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label>–°—Ü–µ–Ω–∞—Ä–∏–π –ø–æ–≤–µ–¥–µ–Ω–∏—è</label>
                    <select id="cfg-scenario">
                        <option value="normal">Normal - –°—Ç–∞–±–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è</option>
                        <option value="drift_up">Drift Up - –ü–ª–∞–≤–Ω—ã–π —Ä–æ—Å—Ç</option>
                        <option value="drift_down">Drift Down - –ü–ª–∞–≤–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ</option>
                        <option value="sine">Sine - –°–∏–Ω—É—Å–æ–∏–¥–∞–ª—å–Ω—ã–µ –∫–æ–ª–µ–±–∞–Ω–∏—è</option>
                        <option value="daily_cycle">Daily Cycle - –°—É—Ç–æ—á–Ω—ã–π —Ü–∏–∫–ª</option>
                        <option value="hvac_control">HVAC Control - –ò–º–∏—Ç–∞—Ü–∏—è HVAC</option>
                        <option value="intermittent">Intermittent - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ —Å–±–æ–∏</option>
                        <option value="offline">Offline - –î–∞—Ç—á–∏–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–º—Å)</label>
                    <input type="number" id="cfg-interval" value="1000" min="100" max="60000">
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∏ -->
    <div class="actions-bar">
        <button class="btn btn-primary" onclick="saveConfig()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn" onclick="loadConfig()">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>
    
    <!-- –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ -->
    <div class="card">
        <div class="card-header">
            <h3>üìã –¢–µ–∫—É—â–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä—ã</h3>
            <button class="btn btn-sm" onclick="refreshRegisters()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div class="card-body">
            <table class="data-table" id="registers-table">
                <thead>
                    <tr>
                        <th>–î–∞—Ç—á–∏–∫</th>
                        <th>–ê–¥—Ä–µ—Å T</th>
                        <th>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</th>
                        <th>Raw</th>
                        <th>–ê–¥—Ä–µ—Å H</th>
                        <th>–í–ª–∞–∂–Ω–æ—Å—Ç—å</th>
                        <th>Raw</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="7" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- –õ–æ–≥ Modbus –∑–∞–ø—Ä–æ—Å–æ–≤ -->
    <div class="card">
        <div class="card-header">
            <h3>üìú –õ–æ–≥ Modbus –ø–æ—Å—ã–ª–æ–∫</h3>
            <div class="header-actions">
                <span id="log-stats" class="log-stats"></span>
                <button class="btn btn-sm" onclick="refreshModbusLog()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                <button class="btn btn-sm btn-danger" onclick="clearModbusLog()">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </div>
        <div class="card-body">
            <div class="log-statistics" id="log-statistics">
                <div class="stat-item">
                    <span class="stat-label">TX:</span>
                    <span class="stat-value" id="stat-tx">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">RX:</span>
                    <span class="stat-value" id="stat-rx">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">–û—à–∏–±–∫–∏:</span>
                    <span class="stat-value" id="stat-errors">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Avg –≤—Ä–µ–º—è:</span>
                    <span class="stat-value" id="stat-avg-time">0 –º—Å</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Min/Max:</span>
                    <span class="stat-value" id="stat-minmax-time">0/0 –º—Å</span>
                </div>
            </div>
            <div class="modbus-log-container">
                <table class="data-table modbus-log-table" id="modbus-log-table">
                    <thead>
                        <tr>
                            <th width="180">–í—Ä–µ–º—è</th>
                            <th width="50">TX/RX</th>
                            <th width="250">Raw HEX</th>
                            <th>–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞</th>
                            <th width="100">–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5" class="loading">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/modbus.js') }}"></script>
{% endblock %}
